<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>empd_admin.repo_test module &#8212; EMPD-admin 0.0.1.dev0 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="empd_admin.viewer_responses module" href="empd_admin.viewer_responses.html" />
    <link rel="prev" title="empd_admin.query module" href="empd_admin.query.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          EMPD-admin</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://EMPD2.github.io">EMPD2.github.io</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../pulls.html">EMPD-data pull requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">empd-admin Command Line Interface</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="empd_admin.html">Python API Reference</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">empd_admin.repo_test module</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="empd_admin.query.html" title="Previous Chapter: empd_admin.query module"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; empd_admin.qu...</span>
    </a>
  </li>
  <li>
    <a href="empd_admin.viewer_responses.html" title="Next Chapter: empd_admin.viewer_responses module"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">empd_admin.vi... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/api/empd_admin.repo_test.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="module-empd_admin.repo_test">
<span id="empd-admin-repo-test-module"></span><h1>empd_admin.repo_test module<a class="headerlink" href="#module-empd_admin.repo_test" title="Permalink to this headline">¶</a></h1>
<p><strong>Functions</strong></p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="#empd_admin.repo_test.comment_on_pr" title="empd_admin.repo_test.comment_on_pr"><code class="xref py py-obj docutils literal notranslate"><span class="pre">comment_on_pr</span></code></a>(owner, repo_name, pr_id, message)</p></td>
<td><p>Comment on a pull request on Github</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#empd_admin.repo_test.download_pr" title="empd_admin.repo_test.download_pr"><code class="xref py py-obj docutils literal notranslate"><span class="pre">download_pr</span></code></a>(repo_owner, repo_name, pr_id, …)</p></td>
<td><p>Clone the repository associated with a certain pull request</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#empd_admin.repo_test.fetch_upstream" title="empd_admin.repo_test.fetch_upstream"><code class="xref py py-obj docutils literal notranslate"><span class="pre">fetch_upstream</span></code></a>(repo)</p></td>
<td><p>Fetch the remote upstream from the EMPD2/EMPD-data github repository</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#empd_admin.repo_test.full_repo_test" title="empd_admin.repo_test.full_repo_test"><code class="xref py py-obj docutils literal notranslate"><span class="pre">full_repo_test</span></code></a>(local_repo, pr_id)</p></td>
<td><p>Run all tests and test the postgres import of a pull request</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#empd_admin.repo_test.get_meta_file" title="empd_admin.repo_test.get_meta_file"><code class="xref py py-obj docutils literal notranslate"><span class="pre">get_meta_file</span></code></a>([dirname])</p></td>
<td><p>Get the meta file of an EMPD-data repository</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#empd_admin.repo_test.import_database" title="empd_admin.repo_test.import_database"><code class="xref py py-obj docutils literal notranslate"><span class="pre">import_database</span></code></a>(meta[, dbname, commit, …])</p></td>
<td><p>Import the EMPD meta data into a postgres database</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#empd_admin.repo_test.pr_info" title="empd_admin.repo_test.pr_info"><code class="xref py py-obj docutils literal notranslate"><span class="pre">pr_info</span></code></a>(local_repo[, pr_owner, pr_repo, …])</p></td>
<td><p>Provide information on a pull request and the intro message</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#empd_admin.repo_test.remember_cwd" title="empd_admin.repo_test.remember_cwd"><code class="xref py py-obj docutils literal notranslate"><span class="pre">remember_cwd</span></code></a>()</p></td>
<td><p>Context manager to switch back to the current working directory</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#empd_admin.repo_test.remember_env" title="empd_admin.repo_test.remember_env"><code class="xref py py-obj docutils literal notranslate"><span class="pre">remember_env</span></code></a>(key)</p></td>
<td><p>Context manager to remember an environment variable</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#empd_admin.repo_test.run_test" title="empd_admin.repo_test.run_test"><code class="xref py py-obj docutils literal notranslate"><span class="pre">run_test</span></code></a>(meta[, pytest_args, tests])</p></td>
<td><p>Run the EMPD-data repository tests for the given meta data</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#empd_admin.repo_test.set_pr_status" title="empd_admin.repo_test.set_pr_status"><code class="xref py py-obj docutils literal notranslate"><span class="pre">set_pr_status</span></code></a>(owner, repo_name, test_info[, …])</p></td>
<td><p>Set the status of a pull request</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#empd_admin.repo_test.temporary_database" title="empd_admin.repo_test.temporary_database"><code class="xref py py-obj docutils literal notranslate"><span class="pre">temporary_database</span></code></a>([dbname])</p></td>
<td><p>Create a temporary database that shall be removed afterwards</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#empd_admin.repo_test.test_get_meta_file" title="empd_admin.repo_test.test_get_meta_file"><code class="xref py py-obj docutils literal notranslate"><span class="pre">test_get_meta_file</span></code></a>(local_repo)</p></td>
<td><p>Test function for <a class="reference internal" href="#empd_admin.repo_test.get_meta_file" title="empd_admin.repo_test.get_meta_file"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_meta_file()</span></code></a></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#empd_admin.repo_test.test_import_database" title="empd_admin.repo_test.test_import_database"><code class="xref py py-obj docutils literal notranslate"><span class="pre">test_import_database</span></code></a>(local_repo)</p></td>
<td><p>Test function for the <a class="reference internal" href="#empd_admin.repo_test.import_database" title="empd_admin.repo_test.import_database"><code class="xref py py-func docutils literal notranslate"><span class="pre">import_database()</span></code></a></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#empd_admin.repo_test.test_pr_info" title="empd_admin.repo_test.test_pr_info"><code class="xref py py-obj docutils literal notranslate"><span class="pre">test_pr_info</span></code></a>(pr_id, tmpdir)</p></td>
<td><p>Test function for the <a class="reference internal" href="#empd_admin.repo_test.pr_info" title="empd_admin.repo_test.pr_info"><code class="xref py py-func docutils literal notranslate"><span class="pre">pr_info()</span></code></a></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#empd_admin.repo_test.test_repo_test" title="empd_admin.repo_test.test_repo_test"><code class="xref py py-obj docutils literal notranslate"><span class="pre">test_repo_test</span></code></a>(pr_id, tmpdir)</p></td>
<td><p>Test function for <a class="reference internal" href="#empd_admin.repo_test.full_repo_test" title="empd_admin.repo_test.full_repo_test"><code class="xref py py-func docutils literal notranslate"><span class="pre">full_repo_test()</span></code></a></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#empd_admin.repo_test.wait_for_pg_server" title="empd_admin.repo_test.wait_for_pg_server"><code class="xref py py-obj docutils literal notranslate"><span class="pre">wait_for_pg_server</span></code></a>([timeout])</p></td>
<td><p>Wait for the postgres server to be started</p></td>
</tr>
</tbody>
</table>
<dl class="function">
<dt id="empd_admin.repo_test.comment_on_pr">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">comment_on_pr</code><span class="sig-paren">(</span><em class="sig-param">owner</em>, <em class="sig-param">repo_name</em>, <em class="sig-param">pr_id</em>, <em class="sig-param">message</em>, <em class="sig-param">force=False</em>, <em class="sig-param">onlyif='last'</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.comment_on_pr" title="Permalink to this definition">¶</a></dt>
<dd><p>Comment on a pull request on Github</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>owner</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The name of the upstream repository owner (EMPD2)</p></li>
<li><p><strong>repo_name</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The name of the upstream repository (EMPD-data)</p></li>
<li><p><strong>pr_id</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#int" title="(in Python v3.7)"><em>int</em></a>) – The number of the pull request</p></li>
<li><p><strong>message</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The markdown formatted message to post</p></li>
<li><p><strong>force</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#bool" title="(in Python v3.7)"><em>bool</em></a>) – If True, ignore <cite>onlyif</cite> and always comment with the given <cite>message</cite></p></li>
<li><p><strong>onlyif</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – Can be either <code class="docutils literal notranslate"><span class="pre">'last'</span></code> to only comment if <cite>message</cite> differs from the
last comment or <code class="docutils literal notranslate"><span class="pre">'any'</span></code> to only comment if <cite>message</cite> has never been
posted in this PR</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The comment that has been posted (or is already existing)</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>github.PullRequestComment</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.download_pr">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">download_pr</code><span class="sig-paren">(</span><em class="sig-param">repo_owner</em>, <em class="sig-param">repo_name</em>, <em class="sig-param">pr_id</em>, <em class="sig-param">target_dir</em>, <em class="sig-param">force=False</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.download_pr" title="Permalink to this definition">¶</a></dt>
<dd><p>Clone the repository associated with a certain pull request</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>repo_owner</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The owner of the upstream repository (EMPD2)</p></li>
<li><p><strong>repo_name</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The name of the upstream repository (EMPD-data)</p></li>
<li><p><strong>pr_id</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#int" title="(in Python v3.7)"><em>int</em></a>) – The number of the pull request</p></li>
<li><p><strong>target_dir</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – Path to a local directory where to clone the repository into</p></li>
<li><p><strong>force</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#bool" title="(in Python v3.7)"><em>bool</em></a>) – The PR can be skipped when the latest commit includes one of
<code class="docutils literal notranslate"><span class="pre">[ci</span> <span class="pre">skip],</span> <span class="pre">[skip</span> <span class="pre">ci],</span> <span class="pre">[admin</span> <span class="pre">skip],</span> <span class="pre">[skip</span> <span class="pre">admin]</span></code>. If force is True,
these messages are ignored</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>An empty dict if everything went well, and the repo was cloned,
otherwise a mapping with the following keys:</p>
<dl class="simple">
<dt>message</dt><dd><p>A detailed explanation of the action (e.g. why it failed or has
been skippd) that can be posted on github (see
<a class="reference internal" href="#empd_admin.repo_test.comment_on_pr" title="empd_admin.repo_test.comment_on_pr"><code class="xref py py-func docutils literal notranslate"><span class="pre">comment_on_pr()</span></code></a>)</p>
</dd>
<dt>sha</dt><dd><p>The hexsha of the PR</p>
</dd>
<dt>status</dt><dd><p><code class="docutils literal notranslate"><span class="pre">'skipped'</span></code> or <code class="docutils literal notranslate"><span class="pre">'merge_conflict'</span></code>, if the tests are skipped or
have the PR has a merge conflict with the upstream repository</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#dict" title="(in Python v3.7)">dict</a></p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.fetch_upstream">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">fetch_upstream</code><span class="sig-paren">(</span><em class="sig-param">repo</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.fetch_upstream" title="Permalink to this definition">¶</a></dt>
<dd><p>Fetch the remote upstream from the EMPD2/EMPD-data github repository</p>
<p>This function adds a new upstream to the given git <cite>repo</cite> (if not already
existent) based on <a class="reference external" href="https://github.com/EMPD2/EMPD-data.git">https://github.com/EMPD2/EMPD-data.git</a></p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>repo</strong> (<em>git.Repo</em>) – The local repository</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.full_repo_test">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">full_repo_test</code><span class="sig-paren">(</span><em class="sig-param">local_repo</em>, <em class="sig-param">pr_id</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.full_repo_test" title="Permalink to this definition">¶</a></dt>
<dd><p>Run all tests and test the postgres import of a pull request</p>
<p>This function is called by the webapp for new pull requests or after a
PR has been edited.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>local_repo</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The path to the local directory where the repository has been cloned
into</p></li>
<li><p><strong>pr_id</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#int" title="(in Python v3.7)"><em>int</em></a>) – The number of the pull request</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A mapping with status information of the PR. The keys are:</p>
<dl class="simple">
<dt>message</dt><dd><p>A markdown formatted message that can be posted on github</p>
</dd>
<dt>status</dt><dd><p>’failure’, ‘mixed’ or ‘good’: Whether the tests passed or not</p>
</dd>
<dt>sha</dt><dd><p>The hexsha of the PR</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#dict" title="(in Python v3.7)">dict</a></p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.get_meta_file">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">get_meta_file</code><span class="sig-paren">(</span><em class="sig-param">dirname='.'</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.get_meta_file" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the meta file of an EMPD-data repository</p>
<p>This function either returns the path to the meta data of a new
contribution or the <code class="docutils literal notranslate"><span class="pre">meta.tsv</span></code> file in the given <cite>dirname</cite>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>dirname</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The path to a local clone of the (forked) EMPD2/EMPD-data repository.
If this directory contains a new file, that is not in the master
branch of EMPD2/EMPD-data, we assume that this is a new contribution
and return this file. Otherwise, we return the <code class="docutils literal notranslate"><span class="pre">meta.tsv</span></code></p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The path to the meta file (not relative to <cite>dirname</cite>)</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)">str</a></p>
</dd>
</dl>
<p class="rubric">Examples</p>
<p>Let’s clone the master branch of EMPD2/EMPD-data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">git</span>
<span class="n">repo</span> <span class="o">=</span> <span class="n">git</span><span class="o">.</span><span class="n">Repo</span><span class="o">.</span><span class="n">clone_from</span><span class="p">(</span><span class="s1">&#39;https://github.com/EMPD2/EMPD-data.git&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, <code class="docutils literal notranslate"><span class="pre">get_meta_file</span></code> returns the <code class="docutils literal notranslate"><span class="pre">meta.tsv</span></code> of this local clone:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">get_meta_file</span><span class="p">(</span><span class="s1">&#39;EMPD-data&#39;</span><span class="p">)</span>
<span class="s1">&#39;meta.tsv&#39;</span>
</pre></div>
</div>
<p>If we create a new file in the root of this repository, we get this one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;EMPD-data/new.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">get_meta_file</span><span class="p">(</span><span class="s1">&#39;EMPD-data&#39;</span><span class="p">)</span>
<span class="s1">&#39;new.tsv&#39;</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.import_database">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">import_database</code><span class="sig-paren">(</span><em class="sig-param">meta</em>, <em class="sig-param">dbname=None</em>, <em class="sig-param">commit=False</em>, <em class="sig-param">populate=None</em>, <em class="sig-param">rebuild_fixed=[]</em>, <em class="sig-param">sql_dump=None</em>, <em class="sig-param">dump_tables=True</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.import_database" title="Permalink to this definition">¶</a></dt>
<dd><p>Import the EMPD meta data into a postgres database</p>
<p>This function import the given EMPD <cite>meta</cite> data into a relational postgres
database and, optionally, dumps the database to the disk. The database can
either be already existing or a new one will be created using the
<a class="reference internal" href="#empd_admin.repo_test.temporary_database" title="empd_admin.repo_test.temporary_database"><code class="xref py py-func docutils literal notranslate"><span class="pre">temporary_database()</span></code></a> function.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>meta</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The path to a tab-delimited EMPD meta data file</p></li>
<li><p><strong>dbname</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The name of a database suitable for the <a class="reference internal" href="#empd_admin.repo_test.temporary_database" title="empd_admin.repo_test.temporary_database"><code class="xref py py-func docutils literal notranslate"><span class="pre">temporary_database()</span></code></a>
function. If None, a temporary database will be created and dropped
at the end</p></li>
<li><p><strong>commit</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#bool" title="(in Python v3.7)"><em>bool</em></a>) – If True, commit the changes to the repository of <cite>meta</cite></p></li>
<li><p><strong>populate</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#bool" title="(in Python v3.7)"><em>bool</em></a><em> or </em><a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – If True, populate the database with the fixed tables (groupid, etc.) of
the EMPD. This parameter is ignored if <cite>dbname</cite> is None. If <cite>populate</cite>
is a string, it must represent the path to a sql file that is used to
fill data into the database</p></li>
<li><p><strong>rebuild_fixed</strong> (<em>list of str</em>) – If this list is not empty, the <cite>meta</cite> is ignored and the fixed tables
of the given database are filled instead.</p></li>
<li><p><strong>sql_dump</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The name of the file where to dump the postgres database (using
<code class="docutils literal notranslate"><span class="pre">pg_dump</span></code>). If None and <cite>commit</cite> is True, it will be saved with the
name of <cite>meta</cite> in the <code class="docutils literal notranslate"><span class="pre">postgres</span></code> directory relative to <cite>meta</cite>.
Otherwise this parameter gives the name of the sql dump in the
<code class="docutils literal notranslate"><span class="pre">postgres</span></code> directory (see also examples below)</p></li>
<li><p><strong>dump_tables</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#bool" title="(in Python v3.7)"><em>bool</em></a>) – If True, update the fixed tables when calling the import script</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><em>bool</em> – Whether the import was successful or not</p></li>
<li><p><em>str</em> – The report of the import</p></li>
<li><p><em>str</em> – The path to the dumped postgres file (see the <cite>sql_dump</cite> and <cite>commit</cite>
parameters)</p></li>
</ul>
</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<p>Transform the meta data of the EMPD2/EMPD-data master into a database into
a temporary postgres database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">git</span> <span class="k">import</span> <span class="n">Repo</span>
<span class="n">repo</span> <span class="o">=</span> <span class="n">Repo</span><span class="o">.</span><span class="n">clone_from</span><span class="p">(</span><span class="s1">&#39;https://github.com/EMPD2/EMPD-data.git&#39;</span><span class="p">)</span>
<span class="n">import_database</span><span class="p">(</span><span class="s1">&#39;EMPD-data/meta.tsv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Dump the database into <code class="docutils literal notranslate"><span class="pre">postgres/dump.sql</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">import_database</span><span class="p">(</span><span class="s1">&#39;EMPD-data/meta.tsv&#39;</span><span class="p">,</span> <span class="n">sql_dump</span><span class="o">=</span><span class="s1">&#39;dump.sql&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.pr_info">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">pr_info</code><span class="sig-paren">(</span><em class="sig-param">local_repo</em>, <em class="sig-param">pr_owner=None</em>, <em class="sig-param">pr_repo=None</em>, <em class="sig-param">pr_branch=None</em>, <em class="sig-param">pr_id=None</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.pr_info" title="Permalink to this definition">¶</a></dt>
<dd><p>Provide information on a pull request and the intro message</p>
<p>This function is used by the webapp to welcome new contributions</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>local_repo</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The path to the local clone of the forked repository</p></li>
<li><p><strong>pr_owner</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The github user name of the PR creator</p></li>
<li><p><strong>pr_repo</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The name of the repo (something like EMPD2/EMPD-data)</p></li>
<li><p><strong>pr_branch</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The branch of the repository (e.g. master)</p></li>
<li><p><strong>pr_id</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/functions.html#int" title="(in Python v3.7)"><em>int</em></a>) – The number of the pull request</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A mapping with the following keys:</p>
<dl class="simple">
<dt>message</dt><dd><p>The message to print on the PR (might be forwarded to
<a class="reference internal" href="#empd_admin.repo_test.comment_on_pr" title="empd_admin.repo_test.comment_on_pr"><code class="xref py py-func docutils literal notranslate"><span class="pre">comment_on_pr()</span></code></a></p>
</dd>
<dt>sha</dt><dd><p>The hexsha of the PR</p>
</dd>
<dt>status</dt><dd><p><code class="docutils literal notranslate"><span class="pre">'failure'</span></code> or <code class="docutils literal notranslate"><span class="pre">'pending'</span></code>, the status that is used by the
<a class="reference internal" href="#empd_admin.repo_test.set_pr_status" title="empd_admin.repo_test.set_pr_status"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_pr_status()</span></code></a> function</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#dict" title="(in Python v3.7)">dict</a></p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.remember_cwd">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">remember_cwd</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.remember_cwd" title="Permalink to this definition">¶</a></dt>
<dd><p>Context manager to switch back to the current working directory</p>
<p>Usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">remember_cwd</span><span class="p">():</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>  <span class="c1"># test</span>
<span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>      <span class="c1"># test/..</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.remember_env">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">remember_env</code><span class="sig-paren">(</span><em class="sig-param">key</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.remember_env" title="Permalink to this definition">¶</a></dt>
<dd><p>Context manager to remember an environment variable</p>
<p>Usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;TEST&#39;</span><span class="p">))</span>       <span class="c1"># old value</span>
<span class="k">with</span> <span class="n">remember_env</span><span class="p">(</span><span class="s1">&#39;TEST&#39;</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TEST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;new value&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;TEST&#39;</span><span class="p">))</span>   <span class="c1"># new value</span>
<span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;TEST&#39;</span><span class="p">))</span>       <span class="c1"># old value</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.run_test">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">run_test</code><span class="sig-paren">(</span><em class="sig-param">meta, pytest_args=[], tests=['']</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.run_test" title="Permalink to this definition">¶</a></dt>
<dd><p>Run the EMPD-data repository tests for the given meta data</p>
<p>This function runs the EMPD tests for the given <cite>meta</cite> data from a local
EMPD-data repository. Tests are ran in a separate process.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>meta</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The path to the tab-delimited EMPD meta data in a local clone of the
EMPD2/EMPD-data repository.</p></li>
<li><p><strong>pytest_args</strong> (<em>list of str</em>) – Any additional arguments passed to the execution of the <code class="docutils literal notranslate"><span class="pre">pytest</span></code>
command</p></li>
<li><p><strong>tests</strong> (<em>list of str</em>) – Test files to use for pytest</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.set_pr_status">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">set_pr_status</code><span class="sig-paren">(</span><em class="sig-param">owner</em>, <em class="sig-param">repo_name</em>, <em class="sig-param">test_info</em>, <em class="sig-param">target_url=None</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.set_pr_status" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the status of a pull request</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>owner</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The owner of the upstream repository (EMPD2)</p></li>
<li><p><strong>repo_name</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The name of the upstream repository (EMPD-data)</p></li>
<li><p><strong>test_info</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#dict" title="(in Python v3.7)"><em>dict</em></a>) – <p>A dictionary with the the following keys:</p>
<dl>
<dt>status</dt><dd><p>One out of</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">'good',</span> <span class="pre">'success',</span> <span class="pre">'mixed'</span></code></dt><dd><p>The commit will be marked as successful</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">'pending'</span></code></dt><dd><p>The commit will be marked as pending</p>
</dd>
<dt>anything else</dt><dd><p>The commit will be marked as failed</p>
</dd>
</dl>
</dd>
<dt>sha</dt><dd><p>The hexsha of the commit whose status shall be modified</p>
</dd>
</dl>
</p></li>
<li><p><strong>target_url</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The url where the status message on Github should link to</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.temporary_database">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">temporary_database</code><span class="sig-paren">(</span><em class="sig-param">dbname=None</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.temporary_database" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a temporary database that shall be removed afterwards</p>
<p>Use this as a context manager:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span> <span class="k">as</span> <span class="nn">psql</span>
<span class="k">with</span> <span class="n">temporary_database</span><span class="p">()</span> <span class="k">as</span> <span class="n">db_url</span><span class="p">:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">psql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_url</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>dbname</strong> (<a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)"><em>str</em></a>) – The name of the database to use. If None, a new temporary database will
be created and dropped afterwards. Otherwise, we assume that it
exists already and it will not be dropped afterwards.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>The url to connect to the database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;postgres://postgres@localhost/&#39;</span> <span class="o">+</span> <span class="n">dbname</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">dbname</span></code> is the given name or the temporary database. The first
part of the query can also be set through the <code class="docutils literal notranslate"><span class="pre">DATABASE_URL</span></code>
environment variable. I.e.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;postgres:///&#39;</span>
</pre></div>
</div>
<dl class="simple">
<dt>will result in::</dt><dd><p>’postgres:///’ + dbname</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3.7/library/stdtypes.html#str" title="(in Python v3.7)">str</a></p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.test_get_meta_file">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">test_get_meta_file</code><span class="sig-paren">(</span><em class="sig-param">local_repo</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.test_get_meta_file" title="Permalink to this definition">¶</a></dt>
<dd><p>Test function for <a class="reference internal" href="#empd_admin.repo_test.get_meta_file" title="empd_admin.repo_test.get_meta_file"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_meta_file()</span></code></a></p>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.test_import_database">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">test_import_database</code><span class="sig-paren">(</span><em class="sig-param">local_repo</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.test_import_database" title="Permalink to this definition">¶</a></dt>
<dd><p>Test function for the <a class="reference internal" href="#empd_admin.repo_test.import_database" title="empd_admin.repo_test.import_database"><code class="xref py py-func docutils literal notranslate"><span class="pre">import_database()</span></code></a></p>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.test_pr_info">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">test_pr_info</code><span class="sig-paren">(</span><em class="sig-param">pr_id</em>, <em class="sig-param">tmpdir</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.test_pr_info" title="Permalink to this definition">¶</a></dt>
<dd><p>Test function for the <a class="reference internal" href="#empd_admin.repo_test.pr_info" title="empd_admin.repo_test.pr_info"><code class="xref py py-func docutils literal notranslate"><span class="pre">pr_info()</span></code></a></p>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.test_repo_test">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">test_repo_test</code><span class="sig-paren">(</span><em class="sig-param">pr_id</em>, <em class="sig-param">tmpdir</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.test_repo_test" title="Permalink to this definition">¶</a></dt>
<dd><p>Test function for <a class="reference internal" href="#empd_admin.repo_test.full_repo_test" title="empd_admin.repo_test.full_repo_test"><code class="xref py py-func docutils literal notranslate"><span class="pre">full_repo_test()</span></code></a></p>
</dd></dl>

<dl class="function">
<dt id="empd_admin.repo_test.wait_for_pg_server">
<code class="sig-prename descclassname">empd_admin.repo_test.</code><code class="sig-name descname">wait_for_pg_server</code><span class="sig-paren">(</span><em class="sig-param">timeout=120</em><span class="sig-paren">)</span><a class="headerlink" href="#empd_admin.repo_test.wait_for_pg_server" title="Permalink to this definition">¶</a></dt>
<dd><p>Wait for the postgres server to be started</p>
<p>This utility function is used for the webapp to make sure that the
postgres server, that starts in a separate process, is running. This is
based on the lockfile at <code class="docutils literal notranslate"><span class="pre">$HOME/starting_pg_server.lock</span></code></p>
</dd></dl>

</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Philipp S. Sommer.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.<br/>
    </p>
  </div>
</footer>
  </body>
</html>